<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>pesticides</title>
    <link rel="stylesheet" href="css/chart-utils.css">
</head>
<body>
<h1>Pesticide use in Agriculture</h1>
<p>Source UN/FAO</p>
<script type="module">
import * as d3 from "https://cdn.skypack.dev/d3@7";
import {load} from "./js/data.js";
import * as utils from "./js/chart-utils.js";

  const file = "./data/FAO-pesticides-use.csv";

  const data = await load(file);
  console.log(data);

  const grouped = d3.rollups(data,
                            v => v[0].value,
                            d => d.country,
                            d => d.year);
  console.log(grouped);

  // Only countries that used more than 1500000 tonnes total since 1990
  const pesticides = grouped.filter(d => d3.sum(d[1].map(v => v[1])) > 2500000)
  console.log(pesticides)

  const dim = {
    width: 1000,
    height: 600,
    margin: {top: 20, right: 100, bottom: 50, left: 100}
  };

  const values = data.map(d => d.value);
  const years = d3.sort(new Set(data.map(d => d.year)));
  const countries = d3.sort(new Set(pesticides.map(d => d[0])));
  console.log(years)
  console.log(countries)

  const scale = {
    x: d3.scaleTime()
          .domain(d3.extent(years.map(d3.timeParse("%Y"))))
          .range([dim.margin.left, dim.width - dim.margin.right]),
    y: d3.scaleLinear()
          .domain([0, d3.max(values)])
          .range([dim.height - dim.margin.bottom, dim.margin.top])
  };

  const line = d3.line()
                 .x(d => scale.x(d3.timeParse("%Y")(d[0])))
                 .y(d => scale.y(d[1]))
                 .defined(d => d[1] !== null && !isNaN(d[1]))
                 .curve(d3.curveBasis);
  const color = d3.scaleOrdinal(d3.schemeCategory10);

  const svg = d3.select("body")
      .append("svg")
      .attr("width", dim.width)
      .attr("height", dim.height);

  svg.selectAll("g.country")
      .data(pesticides)
      .join("g")
        .attr("stroke", (d,i) => color(i))
        .attr("class", "country")
        .selectAll("path")
          .data(d => d)
            .join("path")
                .attr("d", line)
                .attr("fill", "none")
                .attr("stroke-width", 3);

  const [,yAxis] = utils.cartesianAxes()
                       .xScale(scale.x)
                       .yScale(scale.y)
                       .xLabel("Year")
                       .yLabel("Tonnes")
                       .container(svg)();

yAxis.tickFormat(d3.format(".2s"));
d3.select("g.y-axis").call(yAxis);
d3.select(".y-axis .label").attr("dy", 10);

const legend = svg.append("g")
    .attr("transform", `translate(${[dim.width - dim.margin.right + 20, dim.margin.top]})`)

utils.legend()
     .container(legend)
     .data(countries)
     .color(color)();


  // Show line chart, per country, per year
  // Show cumulative stacked area
  // Show pie chart for selected year
</script>
</body>
</html>
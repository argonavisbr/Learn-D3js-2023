<!DOCTYPE html>
<html lang="en">
<head>
    <title>Stacked bar chart</title>
    <script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
    <script src="../js/chart-utils.js"></script>
    <link rel="stylesheet" href="../css/chart-utils.css">
    <style>
        .legend text {
            font-size: 12px !important;
            font-family: sans-serif;
        }
    </style>
</head>
<body>

<script>
    const height  = 500, width   = 800;
    const marginL = 50, marginR = 100, marginY = 50;

    // Use scaleBand() for the x-axis of bar charts - it's easier to align and space the bars
    const scaleX = d3.scaleBand()
                     .range([marginL, width - marginR])
                     .padding(0.5);

    // Use a scaleLinear() for the y-axis, so that the data can be compared
    const scaleY = d3.scaleLinear()
                     .range([height - marginY, marginY]);

    const svg = d3.select("body")
                  .append("svg")
                    .attr("width", width)
                    .attr("height",height);

    // A sample dataset
    const sleep = [
        {day: 'Sun', hours: [ 5.5, 0.9, 1.6 ]},
        {day: 'Mon', hours: [ 4.9, 1.5, 1.1 ]},
        {day: 'Tue', hours: [ 5.1, 1.2, 1 ]},
        {day: 'Wed', hours: [ 3.9, 0.7, 1.1 ]},
        {day: 'Thu', hours: [ 4.6, 1.8, 1.2 ]},
        {day: 'Fri', hours: [ 3.1, 0.5, 0.4 ]},
        {day: 'Sat', hours: [ 6.1, 1.2, 1.2 ]}
    ];
    const stages = ['Light (N1/N2)', 'Deep (N3)', 'REM'];
    const colors = ['#00eeff', '#0088ff', '#0044ff'];

    // set the domains of the scales
    scaleX.domain(sleep.map(d => d.day));
    scaleY.domain([0, d3.max(sleep, d => d3.sum(d.hours))]);

    // render Cartesian axes - this function is from the file cartesian-axes-2.2.js
    pkt.cartesianAxes()
        .container(svg)
        .xScale(scaleX)
        .yScale(scaleY)
        .xLabel('Day of the week')
        .yLabel('Hours of sleep')
        .showHorizontalGrid(true)();

    // create a stacked layout generator for 3 layers of data
    const stack = d3.stack()
                    .keys(stages.map((d,i) => i))
                    .order(d3.stackOrderReverse);

    // apply the generator and obtain the stacked data
    const stackedData = stack(sleep.map(d => d.hours));

    console.log(stackedData)

    // render the stacked bars
    svg.selectAll("g.layer")    // each group represents a layer (phase of sleep)
        .data(stackedData)
        .join("g")
          .attr("class", "layer")
          .attr("fill", (d, i) => colors[i])   // assign a color to each layer
          .selectAll("rect")
            .data(d => d)        // each layer is an array of 2 values: [bottom, top] of a bar in the stack
            .join("rect")
               .attr("y", d => scaleY(d[1]))    // linear scale: top of bar is the top of the layer
               .attr("height", d => scaleY(d[0]) - scaleY(d[1])) // linear scale: height of bar is (bottom - top)
               .attr("x", (d, i) => scaleX(sleep[i].day))   // band scale: x position of the bar
               .attr("width", scaleX.bandwidth());          // band scale: width of the bar

    // Add legend at right margin
    const legend = svg.append("g")
        .attr("transform", `translate(${[width - marginR + 10, height/2 - marginY]})`)
        .attr("class", "legend");

    const colorFunction = d3.scaleOrdinal()
        .domain(stages)
        .range(colors);

    pkt.legend()
        .container(legend)
        .data(stages)
        .color(colorFunction)();

</script>

</body>
</html>
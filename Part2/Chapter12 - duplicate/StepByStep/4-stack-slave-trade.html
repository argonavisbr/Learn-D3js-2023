<!DOCTYPE html>
<html lang="en">
<head>
    <title>Cartesian axes template</title>
    <script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
    <script src="../js/chart-utils.js"></script>
    <link rel="stylesheet" href="../css/chart-utils.css">
    <style>
        .tick line {
            stroke-width: .5;
        }
        h1, p {
            font-family: sans-serif;
        }
        h1 {
            font-size: 16pt;
            text-align: center;
        }
        p {
            font-size: 10px;
            text-align: center;
        }
        text.label {
            font-size: 12px;
        }
        svg {border: 1px solid #ccc;}
    </style>
</head>
<body>
<div id="chart">
<h1>African transatlantic slave trade from 1500 to 1870</h1>
<p>Source: www.slavevoyages.org</p>
</div>
<script>

    // Data from slavevoyages.org
    const file = "../data/slave-trade-data.csv";

    // The data is already in a wide format, where the keys (series) are the flags
    // and the rows are the decades. The data will be stacked by flag.
    d3.csv(file, row => {
        // Parse the decade as a number
        row.Decade = +row.Decade.split("-")[0] - 1;
        // convert other values to number
        Object.entries(row).forEach(([k,v]) => {
            if (k !== "Decade") row[k] = +v;
        });
        return row;
    })
    .then(rows => {
        plot(rows);
    });


    function plot(rawData) {

        // Viewport config
        const easeDim = {
            height: 400, width: 800,
            margin: {top: 10, left: 75, bottom: 60, right: 150}
        };

        const svg = d3.select("body")
                      .append("svg")
                         .attr("width", "100%")
                         .attr("height", "100%")
                         .attr("viewBox", `0 0 ${dim.width} ${dim.height}`);

        const scaleX = d3.scaleTime()
            .range([dim.margin.left, dim.width - dim.margin.right]);

        const scaleY = d3.scaleLinear()
            .range([dim.height - dim.margin.bottom, dim.margin.top]);

        // Data manipulation
        const keys = rawData.columns.filter(d => d !== "Decade");
        const decades = rawData.map(d => d.Decade);

        // The stack generator
        const stack = d3.stack()
                        .keys(keys)
                        .order(d3.stackOrderAppearance)  // Try also inside-out
                        .offset(d3.stackOffsetNone);     // Try also expand, silhouette or wiggle

        // The stack generator returns an array of arrays, each representing a stack of values
        // Each array also has a data property, containing the object
        const stackedData = stack(rawData);
        console.log(stackedData)

        // Since x-axis is time scale, decades are parsed as ISO dates with arbitrary month & day.
        scaleX.domain([d3.isoParse(`${d3.min(decades)}-6-15`),
                       d3.isoParse(`${d3.max(decades)}-6-15`)]);
        // The y-axis domain
        scaleY.domain([0, d3.max(stackedData.flat(2))]);

        // The area function. The x-value can get the decade via d.data[0] or d.data.Decade
        const area = d3.area()
                       .x(d => scaleX(d3.isoParse(`${d.data.Decade}-7-15`)))
                       .y0(d => scaleY(d[0]))
                       .y1(d => scaleY(d[1]))
                       .defined(d => !isNaN(d[1]))
                       .curve(d3.curveBasis);

        // The color scale is mapped to the flags
        const color = d3.scaleOrdinal(d3.schemeCategory10.reverse())
                        .domain(keys);

        // Render the areas
        svg.selectAll("path")
           .data(stackedData)
             .join("path")
             .attr("d", area)
             .style("fill", (d,i) => color(i));

        // Render Cartesian axes
        const yAxis = pkt.cartesianAxes()
                         .container(svg)
                         .xScale(scaleX)
                         .yScale(scaleY)
                         .xLabel('Years')
                         .yLabel('Slaves embarked')
                         .showHorizontalGrid(true)();

        yAxis.tickFormat(d3.format(".2s"));
        d3.select("g.y-axis").call(yAxis);

        // add legend at right
        const legend = svg.append("g")
                          .attr("transform", `translate(${[dim.width - dim.margin.right + 20, dim.margin.top]})`)

        // Uses the flags as data for the legend, and indexes for colors
        pkt.legend()
            .container(legend)
            .data(keys)
            .color(color)();
    }

</script>

</body>
</html>
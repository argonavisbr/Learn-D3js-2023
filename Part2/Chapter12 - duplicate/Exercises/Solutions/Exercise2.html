<!DOCTYPE html>
<html lang="en">
<head>
    <title>Exercise 2: multi-series line chart</title>
    <script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
    <script src="../../js/chart-utils.js"></script>
    <link rel="stylesheet" href="../../css/chart-utils.css">
    <style>
        path.line {
            stroke-width: 2px;
            fill: none;
            opacity: .85
        }
        h1, p {
            font-family: sans-serif;
        }
        h1 {
            font-size: 16pt;
            text-align: center;
        }
        p {
            font-size: 10px;
            text-align: center;
        }
        text.label {
            font-size: 12px;
        }
        svg {border: 1px solid #ccc;}
    </style>
</head>
<body>
<h1>GDP per capita South America <span id="from"></span> to <span id="to"></span></h1>
<p>Source: <span id="source"></span></p>
<script>

    // Choose a dataset. They have a similar compatible format
    const dataset =
    {source: "IMF", file: "../../data/south-america-gdp-imf.csv", from: 1980, to: 2022};
    // {source: "World Bank", file: "../../data/south-america-gdp-wb.csv", from: 1989, to: 2022};

    // This sets the HTML title of the page with the dataset information
    d3.select("#source").text(dataset.source);
    d3.select("#from").text(dataset.from);
    d3.select("#to").text(dataset.to);

    // Parsing this data with d3.csv will generate an array of objects. E.g.: [{...}, {...}, ...]
    // Each object *will* have a 'Country' property and a series of properties for each year
    // Each object *may* also have a 'Code' property with the flag's ISO code
    // E.g.: {Country: "Argentina", Code: "ARG", 1989: 1234, 1990: 2345, ...}
    d3.csv(dataset.file, d3.autoType)
      .then(csv => {
          // This is the default format for the CSV parser:
          // [{Country: "Argentina", 1989: 1234, 1990: 2345, ...}, ...]
          // There is also a columns property with the headers
          console.log("CSV data", csv);  // Check the data in the console

          // Prepare the data
          // This will generate an array of objects, where the data property contains the chart data
          // in default format, e.g.: [{Country: "Argentina", data: [[1989, 1234], [1990, 2345], ...]}, ...]
          const data = csv.map(obj => ({country: obj['Country'],
                                           data: Object.entries(obj)
                                                       .filter(d => d[0] !== 'Country' && d[0] !== 'Code')}));
          console.log("Prepared data", data);  // Check the data in the console

          // This will return an array will all the years in the dataset
          // e.g. [1989, 1990, 1991, ...]
          const years = csv.columns.filter(d => (d !== 'Country' && d !== 'Code'))
                                   .map(d => +d);
          console.log("Years", years);  // Check the data in the console

          // Render the chart
          plot(data, years);
    });

    function plot(data, years) {
        const height = 500, width = 800;
        const marginL = 75, marginR = 100, marginT = 20, marginB = 60;

        // Container
        const svg = d3.select("body")
                      .append("svg")
                        .attr("width", width)
                        .attr("height",height);

        // Scales and colors
        const scaleX = d3.scaleTime()
                         .range([marginL, width - marginR])
                         .domain([d3.isoParse(`${d3.min(years)}-1-1`), d3.isoParse(`${d3.max(years)}-1-1`)]);
        const scaleY = d3.scaleLinear()
                         .range([height - marginB, marginT])
                         .domain([0, d3.max(data, d => d3.max(d.data, v => v[1]))]);

        const color = d3.scaleOrdinal(['#444', 'gold'].concat(d3.schemeCategory10)) // add +2 colors
                        .domain(data.map(d => d.country));

        // Line function
        const line = d3.line()
            .x(d => scaleX(d3.isoParse(`${d[0]}-1-1`)))  // isoParse creates a date from ISO date string (YYYY-MM-DD)
            .y(d => scaleY(d[1]))
            .curve(d3.curveCardinal.tension(.7))
            .defined(d => !isNaN(d[1]));                 // Skip (interpolate) NaN values

        // Render the line
        svg.selectAll("path.line")
           .data(data.map(d => d.data))
             .join("path")
                .attr("class", "line")
                .attr("d", line)
                .style("stroke", (d,i) => color(i));

        // Render Cartesian axes (utility function from cartesian-chart-utils.js)
        const yAxis = pkt.cartesianAxes()
                         .container(svg)
                         .xScale(scaleX)
                         .yScale(scaleY)
                         .xLabel('Years')
                         .yLabel('GDP per capita (current US$)')
                         .showHorizontalGrid(true)
                         .showVerticalGrid(true)();
        yAxis.tickFormat(d3.format(".0s"));
        d3.select("g.y-axis").call(yAxis);

        // Add legend at right (utility function from cartesian-chart-utils.js)
        const legend = svg.append("g")
                          .attr("transform", `translate(${width - marginR + 20}, ${marginT})`)

        pkt.legend()
            .container(legend)
            .data(data.map(d => d.country))
            .color(color)();
    }

</script>

</body>
</html>